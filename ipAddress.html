<!DOCTYPE html>
<head>
    <meta charset="utf-8">

    <title>M.T. Geolocation</title>
    <link rel="stylesheet" href="css/styles.css" type="text/css" />
    <style>
        #container { opacity: 0.8;}

    </style>
</head>
<body>
    <header>

    </header>

    <h1>M.T. Geolocation</h1>   
    <p><aside style="margin-top:-63px;">Map represents approximate location of site visitor upon lead conversion </aside>
    <div id="container"></div>
    <script src="http://code.jquery.com/jquery-1.10.2.min.js"></script>
    <script src="http://d3js.org/d3.v3.min.js"></script>
    <script src="http://d3js.org/topojson.v1.min.js"></script>
    <script src="js/datamaps-all.min.js"></script>
    <script>
        $(function() {
            var point,
                num = 0;
            var ipPoint = Backbone.Model.extend({
                defaults: {
                    ipAddress: '71.193.202.188',
                    latitude: 45,
                    longitude: -122,
                    radius: 3
                }

            });

            var pointsList = new Backbone.Collection({
                model: ipPoint,
            
            });


            function generateRandomIpAddress() {
                var out = '';
                for (var i = 0; i < 4; i++) {
                    num = Math.floor(Math.random() * 255) + ((i === 3) ? '' : '.');
                    out += num;
                }
                return out;
            }

            function getPointData(callback) {
                var ip = generateRandomIpAddress();
                var point = {};
                $.ajax({
                    url: 'http://freegeoip.net/json/' + ip,
                    method: 'GET',
                    dataType: 'json',
                    async: false,
                    success: function(data) {
                        point['ipAddress'] = ip;
                        point['latitude'] = data['latitude']
                        point['longitude'] = data['longitude'];
                        point['radius'] = 3;
                    },
                    error: function() {
                        console.log('ajax error')
                    }

                });
                return point;
            }


            for (var i = 0; i < 10; i++) {
                point = getPointData();
                pointsList.add(new ipPoint(point));
            }
            
            
            $('#container').datamap({
                element: document.getElementById('container'),
                scope: 'world',
                
                bubbles: pointsList.toJSON(),
                bubble_config: {
                    popupTemplate: _.template([
                        '<div class="hoverinfo">Lat:<%= data.latitude %><br />Lng:<%= data.longitude %>',
                        '<br/>IP Address: <%= data.ipAddress %>',
                        '</div>'].join(''))
                },
                geography_config: {
                    popupOnHover: false,
                    highlightOnHover: false,
                    borderWidth: 1
                },
                done: function() {
                    alert('yeehaw')
                },
                fills: {
                    'USA': '#1f77b4',
                    'RUS': '#9467bd',
                    'PRK': '#ff7f0e',
                    'PRC': '#2ca02c',
                    'IND': '#e377c2',
                    'GBR': '#8c564b',
                    'FRA': '#d62728',
                    'PAK': '#7f7f7f',
                    'ORA': '#f80',
                    defaultFill: '#0f0'
                },/*
                 data: {
                 'RUS': {fillKey: 'RUS'},
                 'PRK': {fillKey: 'PRK'},
                 'CHN': {fillKey: 'PRC'},
                 'IND': {fillKey: 'IND'},
                 'GBR': {fillKey: 'GBR'},
                 'FRA': {fillKey: 'FRA'},
                 'PAK': {fillKey: 'PAK'},
                 'USA': {fillKey: 'USA'}
                 }*/
            });
        });
    </script>
</body>
</html>